global
	chroot /usr/local/etc/haproxy
	user haproxy
	group haproxy
	daemon
	maxconn 4096
	pidfile /run/haproxy.pid
	tune.ssl.default-dh-param 2048

defaults
	mode http
	timeout connect 5s
	timeout client 1m
	timeout server 1m
	option redispatch
	balance leastconn

listen stats
	bind *:1936
	mode http
	stats enable
	stats hide-version
	stats uri /


frontend http-in
	bind *:80

<% plugins.each_pair do |plugin, instances| %>
	acl host_<%= plugin %> hdr_end(host) -i <%= plugin %>.internal
	use_backend <%= plugin %>_cluster if host_<%= plugin %>
<% end %>

<% plugins.each_pair do |plugin, instances| %>

backend <%= plugin %>_cluster
	option httpclose

	option httpchk GET /health
	http-check expect rstatus (2|3)[0-9][0-9]

	acl original_host req.hdr_val(X-Original-Host) -m found
	http-request set-header Host %[req.hdr(X-Original-Host)] if original_host
	http-request set-uri https://%[req.hdr(X-Original-Host)]%[path]?%[query] if original_host

	<% instances.each_pair do |instance, ip_with_port| %>
	server app_<%= instance %> <%= ip_with_port %> check maxconn 1000 inter <%= LOCAL_TEST_MODE ? '60s' : '2s' %> rise 3 fall 2
	<% end %>

<% end %>
